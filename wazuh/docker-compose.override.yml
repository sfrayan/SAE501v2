# docker-compose.override.yml - Configuration personnalisée Wazuh pour SAE 5.01
#
# Ce fichier complète docker-compose.yml du projet wazuh-docker
# À copier dans: /opt/wazuh-docker/single-node/docker-compose.override.yml
#
# Usage:
#   docker compose up -d  (applique automatiquement les overrides)
#
# Documentation: https://docs.docker.com/compose/extends/

version: '3'

services:
  # ============================================
  # WAZUH MANAGER - Configuration personnalisée
  # ============================================
  wazuh.manager:
    # Limites ressources adaptées pour VM
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    
    # Ports supplémentaires pour intégration
    ports:
      - "1514:1514"     # Agent enrollment (TCP)
      - "1515:1515"     # Agent communication (TCP)
      - "514:514/udp"   # Syslog pour routeur TP-Link
      - "55000:55000"   # Wazuh API
    
    # Variables d'environnement personnalisées
    environment:
      - INDEXER_URL=https://wazuh.indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=SecretPassword
      - FILEBEAT_SSL_VERIFICATION_MODE=full
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem
      - SSL_CERTIFICATE=/etc/ssl/filebeat.pem
      - SSL_KEY=/etc/ssl/filebeat.key
      # Logging avancé
      - WAZUH_MANAGER_LOG_LEVEL=info
      - WAZUH_CLUSTER_DISABLED=yes
    
    # Volumes supplémentaires pour configurations SAE501
    volumes:
      # Configurations personnalisées depuis le projet
      - ../../../SAE501v2/wazuh/local_rules.xml:/var/ossec/etc/rules/local_rules.xml:ro
      - ../../../SAE501v2/wazuh/manager.conf:/var/ossec/etc/ossec.conf:ro
      
      # Logs externes à monitorer
      - /var/log/radius-auth.log:/var/log/radius-auth.log:ro
      - /var/log/remote-syslog.log:/var/log/remote-syslog.log:ro
      - /var/log/freeradius:/var/log/freeradius:ro
    
    # Configuration réseau
    networks:
      - wazuh
    
    # Redémarrage automatique
    restart: unless-stopped
    
    # Health check personnalisé
    healthcheck:
      test: [
        "CMD-SHELL",
        "/var/ossec/bin/wazuh-control status | grep -q 'is running'"
      ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================
  # WAZUH INDEXER - Configuration optimisée
  # ============================================
  wazuh.indexer:
    # Limites ressources
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 3G
        reservations:
          cpus: '1.0'
          memory: 2G
    
    # Variables JVM optimisées
    environment:
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
      - bootstrap.memory_lock=true
      - "DISABLE_INSTALL_DEMO_CONFIG=true"
      - discovery.type=single-node
      - network.host=0.0.0.0
      - plugins.security.ssl.http.enabled=true
      - plugins.security.allow_default_init_securityindex=true
    
    # Ulimits pour performance
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: [
        "CMD-SHELL",
        "curl -sku admin:SecretPassword https://localhost:9200/_cluster/health | grep -q '\"status\":\"green\\|yellow\"'"
      ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # ============================================
  # WAZUH DASHBOARD - Configuration UI
  # ============================================
  wazuh.dashboard:
    # Limites ressources
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Port HTTPS
    ports:
      - "443:5601"
    
    environment:
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=SecretPassword
      - WAZUH_API_URL=https://wazuh.manager
      - DASHBOARD_USERNAME=kibanaserver
      - DASHBOARD_PASSWORD=kibanaserver
      - SERVER_SSL_ENABLED=true
      - OPENSEARCH_HOSTS=https://wazuh.indexer:9200
    
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: [
        "CMD-SHELL",
        "curl -sku admin:SecretPassword https://localhost:5601/api/status | grep -q '\"status\":{\"overall\":{\"level\":\"available\"'"
      ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    
    # Dépend des autres services
    depends_on:
      wazuh.indexer:
        condition: service_healthy
      wazuh.manager:
        condition: service_healthy

# ============================================
# RÉSEAUX
# ============================================
networks:
  wazuh:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/24

# ============================================
# VOLUMES PERSISTANTS
# ============================================
volumes:
  # Volumes supplémentaires pour données SAE501
  wazuh_custom_rules:
    driver: local
  wazuh_custom_decoders:
    driver: local
  wazuh_radius_logs:
    driver: local

# ============================================
# NOTES D'UTILISATION
# ============================================
#
# 1. COPIER CE FICHIER:
#    sudo cp wazuh/docker-compose.override.yml /opt/wazuh-docker/single-node/
#
# 2. REDÉMARRER WAZUH:
#    cd /opt/wazuh-docker/single-node
#    docker compose down
#    docker compose up -d
#
# 3. VÉRIFIER L'APPLICATION DES OVERRIDES:
#    docker compose config | grep -A 5 "ports:"
#
# 4. MONITORING RESSOURCES:
#    docker stats
#
# 5. LOGS EN TEMPS RÉEL:
#    docker compose logs -f wazuh.manager
#
# 6. AJUSTER LES LIMITES MÉMOIRE:
#    Si votre VM a moins de 8GB RAM, réduire:
#    - wazuh.indexer: memory: 2G (au lieu de 3G)
#    - OPENSEARCH_JAVA_OPTS: -Xms512m -Xmx512m
#
# ============================================
