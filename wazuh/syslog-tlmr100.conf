<!--
  syslog-tlmr100.conf - Configuration collecte logs TL-MR100 via syslog
  
  Fichier: wazuh/syslog-tlmr100.conf
  Auteur: GroupeNani
  Date: 4 janvier 2026
  
  Description:
    Configuration pour recevoir et traiter les logs du routeur TL-MR100.
    Le routeur envoie les logs syslog vers le serveur Wazuh (port 514 UDP).
    
  Fonctionnalités:
    - Réception logs syslog TL-MR100
    - Décodeurs personnalisés pour format TP-Link
    - Détection événements Wi-Fi (connexions, déconnexions)
    - Détection tentatives accès non autorisées
    - Suivi trafic clients
    - Alertes routeur critique
    
  Prérequis:
    1. Activer syslog sur TL-MR100 (Admin → System → Logs → Syslog Server)
    2. Configurer IP syslog server: 192.168.10.254:514
    3. Copier ce fichier dans Wazuh
-->

<!-- ============================================
     DECODER: Logs TL-MR100
     ============================================ -->

<decoders>
  <!-- Decoder principal TP-Link -->
  <decoder name="tp-link-router">
    <program_name>TL-MR100|tp-link|mr100</program_name>
  </decoder>
  
  <!-- Decoder WiFi TP-Link -->
  <decoder name="tp-link-wifi">
    <parent>tp-link-router</parent>
    <regex>^(\w+)\s+(\d+)\s+(\d+:\d+:\d+)\s+(\S+)\s+WiFi:\s+(.*)$</regex>
    <order>action, timestamp, hostname, message</order>
  </decoder>
  
  <!-- Decoder connexion WiFi -->
  <decoder name="tp-link-wifi-connect">
    <parent>tp-link-wifi</parent>
    <regex>(\S+)\s+associated\s+|(\S+)\s+connected</regex>
    <order>client_mac</order>
  </decoder>
  
  <!-- Decoder déconnexion WiFi -->
  <decoder name="tp-link-wifi-disconnect">
    <parent>tp-link-wifi</parent>
    <regex>(\S+)\s+disassociated\s+|(\S+)\s+disconnected</regex>
    <order>client_mac</order>
  </decoder>
  
  <!-- Decoder authentification WiFi -->
  <decoder name="tp-link-wifi-auth">
    <parent>tp-link-wifi</parent>
    <regex>authentication\s+(succeeded|failed)\s+for\s+(\S+)</regex>
    <order>auth_result, client_mac</order>
  </decoder>
  
  <!-- Decoder événement sécurité -->
  <decoder name="tp-link-security">
    <parent>tp-link-router</parent>
    <regex>^(\w+)\s+(\d+)\s+(\d+:\d+:\d+)\s+(\S+)\s+(\w+):\s+(.*)$</regex>
    <order>action, timestamp, hostname, event_type, message</order>
  </decoder>
  
  <!-- Decoder attaque DoS/intrusion -->
  <decoder name="tp-link-attack">
    <parent>tp-link-security</parent>
    <regex>DoS\s+attack|ICMP\s+flood|SYN\s+flood|Port\s+scan|Intrusion|brute.?force</regex>
  </decoder>
</decoders>

<!-- ============================================
     RÈGLES: TL-MR100 Logs
     ============================================ -->

<group name="tp-link,tlmr100,router">
  
  <!-- ============================================
       WiFi - Connexions Autorisées
       ============================================ -->
  
  <!-- Client WiFi se connecte -->
  <rule id="6000" level="3">
    <match>associated|connected|WiFi.*connect</match>
    <group>wifi_client_connect</group>
    <description>Client WiFi connecté au routeur TL-MR100</description>
  </rule>
  
  <!-- Client se connecte au SSID "Fitness-Pro" -->
  <rule id="6001" level="3">
    <match>Fitness-Pro|Fitness-Corp|Fitness-Guest</match>
    <group>wifi_client_connect</group>
    <description>Client connecté au SSID autorisé TL-MR100</description>
  </rule>
  
  <!-- ============================================
       WiFi - Déconnexions
       ============================================ -->
  
  <!-- Client WiFi se déconnecte -->
  <rule id="6010" level="2">
    <match>disassociated|disconnected|WiFi.*disconnect</match>
    <group>wifi_client_disconnect</group>
    <description>Client WiFi déconnecté du routeur TL-MR100</description>
  </rule>
  
  <!-- ============================================
       WiFi - Authentifications
       ============================================ -->
  
  <!-- Authentification WiFi réussie -->
  <rule id="6020" level="3">
    <match>authentication succeeded|auth.*success|802.1X.*success</match>
    <group>wifi_auth_success</group>
    <description>Authentification WiFi réussie (802.1X/RADIUS)</description>
  </rule>
  
  <!-- Authentification WiFi échouée -->
  <rule id="6021" level="5">
    <match>authentication failed|auth.*failed|802.1X.*failed|authentication error</match>
    <group>wifi_auth_failure</group>
    <description>Authentification WiFi échouée - Accès refusé</description>
  </rule>
  
  <!-- Tentatives multiples échouées (bruteforce) -->
  <rule id="6022" level="7">
    <if_matched_group>wifi_auth_failure</if_matched_group>
    <same_source_ip />
    <frequency>5</frequency>
    <timeframe>300</timeframe>
    <group>wifi_bruteforce</group>
    <description>Bruteforce WiFi détecté (5+ authentifications échouées en 5 min)</description>
  </rule>
  
  <!-- ============================================
       WiFi - Événements de Sécurité
       ============================================ -->
  
  <!-- WPA/WPA2 invalide ou faible -->
  <rule id="6030" level="6">
    <match>WPA disabled|WPA weak|encryption disabled|security disabled|open network</match>
    <group>wifi_security_issue</group>
    <description>Configuration WiFi sécurité faible détectée sur TL-MR100</description>
  </rule>
  
  <!-- Changement clé WiFi -->
  <rule id="6031" level="5">
    <match>WiFi password changed|PSK changed|Pre-shared key changed|WEP key changed</match>
    <group>wifi_config_changed</group>
    <description>Clé WiFi modifiée sur TL-MR100</description>
  </rule>
  
  <!-- ============================================
       Attaques Réseau Détectées
       ============================================ -->
  
  <!-- Attaque DoS détectée -->
  <rule id="6040" level="8">
    <match>DoS attack|Denial of Service|ICMP flood|SYN flood|UDP flood</match>
    <group>router_attack</group>
    <description>Attaque DoS détectée sur TL-MR100 - Action requise</description>
  </rule>
  
  <!-- Scan de port -->
  <rule id="6041" level="6">
    <match>Port scan|port scanning detected|nmap detected|masscan detected</match>
    <group>router_port_scan</group>
    <description>Scan de port détecté sur TL-MR100</description>
  </rule>
  
  <!-- Tentative bruteforce WPA/WiFi -->
  <rule id="6042" level="7">
    <match>brute.?force|dictionary attack|WiFi password attempt</match>
    <group>wifi_bruteforce_attack</group>
    <description>Tentative bruteforce WiFi (attaque par dictionnaire)</description>
  </rule>
  
  <!-- Intrusion/Exploit détecté -->
  <rule id="6043" level="9">
    <match>intrusion detected|exploit detected|malicious traffic|suspicious activity</match>
    <group>router_intrusion</group>
    <description>Intrusion/Exploit détecté sur TL-MR100 - Alerte critique</description>
  </rule>
  
  <!-- ============================================
       Accès Administration
       ============================================ -->
  
  <!-- Connexion admin réussie -->
  <rule id="6050" level="4">
    <match>admin login|administrator login|management interface login</match>
    <group>admin_login</group>
    <description>Accès interface administration TL-MR100</description>
  </rule>
  
  <!-- Échec connexion admin -->
  <rule id="6051" level="5">
    <match>admin login failed|administrator login failed|invalid credentials</match>
    <group>admin_login_failed</group>
    <description>Tentative accès admin échouée sur TL-MR100</description>
  </rule>
  
  <!-- Modification configuration -->
  <rule id="6052" level="6">
    <match>configuration changed|settings modified|configuration updated</match>
    <group>admin_config_change</group>
    <description>Configuration du routeur TL-MR100 modifiée</description>
  </rule>
  
  <!-- ============================================
       État Routeur & Services
       ============================================ -->
  
  <!-- Redémarrage du routeur -->
  <rule id="6060" level="5">
    <match>reboot|restart|system startup|warm reset|cold reset</match>
    <group>router_restart</group>
    <description>Redémarrage du routeur TL-MR100 détecté</description>
  </rule>
  
  <!-- Perte de connexion WAN -->
  <rule id="6061" level="6">
    <match>WAN disconnected|internet lost|connection lost|WAN down</match>
    <group>wan_disconnected</group>
    <description>Perte de connexion WAN sur TL-MR100</description>
  </rule>
  
  <!-- RADIUS connexion perdue -->
  <rule id="6062" level="7">
    <match>RADIUS server unreachable|RADIUS timeout|RADIUS connection failed|RADIUS error</match>
    <group>radius_connection_error</group>
    <description>Perte de connexion au serveur RADIUS depuis TL-MR100 - WiFi Enterprise compromise</description>
  </rule>
  
  <!-- ============================================
       Alertes d'Erreurs
       ============================================ -->
  
  <!-- Erreur critique -->
  <rule id="6070" level="7">
    <match>critical error|fatal error|system crash|kernel panic</match>
    <group>router_critical_error</group>
    <description>Erreur critique sur TL-MR100 - Intervention requise</description>
  </rule>
  
  <!-- Disque/Mémoire plein -->
  <rule id="6071" level="6">
    <match>disk full|storage full|memory full|no space|out of memory</match>
    <group>router_resource_critical</group>
    <description>Ressource critique pleine sur TL-MR100 (disque/mémoire)</description>
  </rule>
  
  <!-- ============================================
       Alertes Composées
       ============================================ -->
  
  <!-- Attaque + RADIUS down = Compromission possible -->
  <rule id="6080" level="9">
    <if_matched_group>router_attack,radius_connection_error</if_matched_group>
    <frequency>2</frequency>
    <timeframe>300</timeframe>
    <group>critical_incident</group>
    <description>Incident critique détecté: Attaque + perte RADIUS sur TL-MR100</description>
  </rule>
  
  <!-- Multiple bruteforce = Attaque coordonnée -->
  <rule id="6081" level="9">
    <if_matched_group>wifi_bruteforce,wifi_bruteforce_attack,admin_login_failed</if_matched_group>
    <frequency>2</frequency>
    <timeframe>600</timeframe>
    <group>coordinated_attack</group>
    <description>Attaque coordonnée détectée sur TL-MR100 - Alerter immédiatement</description>
  </rule>

</group>

<!-- ============================================
     CONFIGURATION SYSLOG (rsyslog.conf)
     ============================================ -->

<!--
  À ajouter dans /etc/rsyslog.d/wazuh.conf:
  
  # Recevoir syslog depuis TL-MR100 (UDP 514)
  input(type="imudp" port="514" tag="TL-MR100")
  
  # Rediriger vers Wazuh agent (port 1514)
  :msg, contains, "TL-MR100" @@localhost:1514
  
  Redémarrer rsyslog:
  $ sudo systemctl restart rsyslog
-->

<!-- ============================================
     NOTES DE CONFIGURATION
     ============================================ -->

<!--
  Installation & Configuration:
  
  1. Activer syslog sur TL-MR100:
     - Web Admin: 192.168.10.1
     - System → Logs → Syslog Server
     - Server IP: 192.168.10.254
     - Port: 514
     - Sauvegarder
  
  2. Copier les fichiers:
     $ sudo cp wazuh/manager.conf /var/ossec/etc/
     $ sudo cp wazuh/local_rules.xml /var/ossec/etc/rules/
     $ sudo cp wazuh/syslog-tlmr100.conf /var/ossec/etc/decoders/
  
  3. Permissions:
     $ sudo chown root:wazuh /var/ossec/etc/decoders/syslog-tlmr100.conf
     $ sudo chmod 640 /var/ossec/etc/decoders/syslog-tlmr100.conf
  
  4. Redémarrer Wazuh:
     $ sudo systemctl restart wazuh-manager
  
  5. Vérifier les logs:
     $ sudo tail -f /var/ossec/logs/ossec.log
     $ sudo grep "TL-MR100" /var/ossec/logs/alerts/alerts.log
  
  Format logs TL-MR100 attendu:
  Jan  4 12:30:45 TL-MR100 WiFi: aa:bb:cc:dd:ee:ff associated
  Jan  4 12:31:00 TL-MR100 WiFi: authentication succeeded for aa:bb:cc:dd:ee:ff
  Jan  4 12:35:15 TL-MR100 Security: DoS attack detected from 203.0.113.5
-->

