<!--
  local_rules.xml - Règles Wazuh personnalisées SAE 5.01 (CORRIGÉ v2.0)
  
  Fichier: wazuh/local_rules.xml
  Auteur: GroupeNani
  Date: 2 février 2026
  Version: 2.0 (format logs RADIUS réel)
  
  Description:
    Règles personnalisées pour détecter les alertes sécurité spécifiques au projet.
    À copier vers: /var/ossec/etc/rules/local_rules.xml
    
  Événements détectés:
    - Authentifications RADIUS (succès/échecs) - FORMAT RÉEL
    - Tentatives bruteforce (5+ échecs en 5 min)
    - Changements utilisateurs RADIUS
    - Modifications fichiers configuration critique
    - Arrêt services critiques
    - Escalade de privilèges (sudo)
    
  Changements v2.0:
    - CORRECTION patterns pour matcher format réel: "Result=Access-Accept" au lieu de "Received Access-Accept"
    - AJOUT règle pour ignorer warnings GROUP_MEMBERSHIP (level 0)
    - Adaptation à la sortie réelle du module linelog
-->

<group name="sae501,radius,authentication">

  <!-- ============================================
       AUTHENTIFICATIONS RADIUS RÉUSSIES
       ============================================ -->
  
  <!-- Détecte une authentification RADIUS réussie - FORMAT RÉEL -->
  <rule id="5001" level="3">
    <match>Result=Access-Accept|result=Access-Accept</match>
    <group>radius_auth_success</group>
    <description>Authentification RADIUS réussie</description>
  </rule>

  <!-- Détecte authentification réussie pour utilisateur spécifique -->
  <rule id="5002" level="3">
    <regex>user=\S+@gym\.fr.*[Rr]esult=Access-Accept</regex>
    <group>radius_auth_success</group>
    <description>Authentification WiFi réussie pour utilisateur RADIUS</description>
  </rule>

  <!-- ============================================
       AUTHENTIFICATIONS RADIUS ÉCHOUÉES
       ============================================ -->
  
  <!-- Détecte une authentification RADIUS échouée - FORMAT RÉEL -->
  <rule id="5010" level="5">
    <match>Result=Access-Reject|result=Access-Reject|Auth-Type=Reject|authentication failed</match>
    <group>radius_auth_failure</group>
    <description>Authentification RADIUS échouée - Accès refusé</description>
  </rule>

  <!-- Utilisateur spécifique refusé -->
  <rule id="5011" level="5">
    <regex>user=\S+@gym\.fr.*[Rr]esult=Access-Reject</regex>
    <group>radius_auth_failure</group>
    <description>Authentification WiFi échouée pour utilisateur RADIUS</description>
  </rule>

  <!-- ============================================
       WARNINGS NON CRITIQUES (IGNORÉS)
       ============================================ -->
  
  <!-- Ignorer warnings GROUP_MEMBERSHIP MySQL (non critiques) -->
  <rule id="5012" level="0">
    <match>Cannot do check groups when group_membership_query is not set</match>
    <group>radius_info</group>
    <description>Warning MySQL non critique (ignoré)</description>
  </rule>

  <!-- Ignorer warnings SQL queries non configurées -->
  <rule id="5013" level="0">
    <match>sql: WARNING|group_membership_query|groupcheck_query|groupreply_query</match>
    <group>radius_info</group>
    <description>Warning SQL non critique (ignoré)</description>
  </rule>

  <!-- ============================================
       ERREURS CRITIQUES RADIUS
       ============================================ -->
  
  <!-- Erreur TLS/certificat -->
  <rule id="5020" level="7">
    <match>TLS error|certificate error|SSL error|PEAP error</match>
    <group>radius_tls_error</group>
    <description>Erreur TLS/Certificat dans authentification RADIUS</description>
  </rule>

  <!-- Erreur de connexion base de données (VRAIES erreurs seulement) -->
  <rule id="5021" level="8">
    <match>Connection refused|Can't connect to MySQL|Access denied for user</match>
    <group>radius_database_error</group>
    <description>Erreur de connexion à la base de données RADIUS</description>
  </rule>

  <!-- ============================================
       ARRÊT SERVICES CRITIQUES
       ============================================ -->
  
  <!-- FreeRADIUS arrêté -->
  <rule id="5030" level="8">
    <match>freeradius stopped|freeradius terminated|freeradius died</match>
    <group>service_stopped</group>
    <description>Service FreeRADIUS arrêté - Authentification Wi-Fi compromise</description>
  </rule>

  <!-- MySQL/MariaDB arrêté -->
  <rule id="5031" level="8">
    <match>mysqld stopped|mysqld terminated|mysqld died</match>
    <group>service_stopped</group>
    <description>Service MySQL arrêté - Base de données inaccessible</description>
  </rule>

  <!-- ============================================
       MODIFICATIONS CRITIQUES
       ============================================ -->
  
  <!-- Fichier clients.conf modifié -->
  <rule id="5040" level="7">
    <match>/etc/freeradius/3.0/clients.conf</match>
    <group>file_modified</group>
    <description>Fichier de configuration RADIUS modifié (clients.conf)</description>
  </rule>

  <!-- Fichier utilisateurs modifié -->
  <rule id="5041" level="7">
    <match>/etc/freeradius/3.0/users</match>
    <group>file_modified</group>
    <description>Fichier utilisateurs RADIUS modifié</description>
  </rule>

  <!-- Configuration SSH modifiée -->
  <rule id="5042" level="6">
    <match>/etc/ssh/sshd_config</match>
    <group>file_modified</group>
    <description>Configuration SSH modifiée</description>
  </rule>

  <!-- Certificats RADIUS modifiés -->
  <rule id="5043" level="8">
    <match>/etc/freeradius/3.0/certs/server.pem|/etc/freeradius/3.0/certs/server.key</match>
    <group>file_modified</group>
    <description>Certificats RADIUS modifiés - Risque de sécurité</description>
  </rule>

  <!-- ============================================
       SSH - AUTHENTIFICATIONS ÉCHOUÉES
       ============================================ -->
  
  <!-- SSH: Tentative connexion root refusée -->
  <rule id="5051" level="5">
    <match>Failed password for root|authentication failure.*user=root</match>
    <group>ssh_root_attack</group>
    <description>Tentative connexion SSH en tant que root - Attaque probable</description>
  </rule>

  <!-- SSH: Échec d'authentification -->
  <rule id="5052" level="4">
    <match>Failed password|Invalid user|authentication failure</match>
    <group>ssh_auth_failure</group>
    <description>Échec d'authentification SSH</description>
  </rule>

  <!-- ============================================
       ESCALADE DE PRIVILÈGES
       ============================================ -->
  
  <!-- Sudo: Exécution de commande -->
  <rule id="5060" level="6">
    <match>sudo.*COMMAND=</match>
    <group>privilege_escalation</group>
    <description>Exécution de commande via sudo</description>
  </rule>

  <!-- Sudo: Échec authentification -->
  <rule id="5061" level="7">
    <match>sudo.*authentication failure|sudo:.*auth</match>
    <group>privilege_escalation_fail</group>
    <description>Échec tentative escalade de privilèges via sudo</description>
  </rule>

  <!-- ============================================
       ÉVÉNEMENTS SYSTÈME CRITIQUES
       ============================================ -->
  
  <!-- UFW: Paquet bloqué -->
  <rule id="5070" level="4">
    <match>UFW BLOCK</match>
    <group>firewall_blocked</group>
    <description>Paquet bloqué par UFW (tentative accès port fermé)</description>
  </rule>

  <!-- Port 1812 (RADIUS): Accès non autorisé -->
  <rule id="5071" level="6">
    <match>UFW BLOCK.*1812|UFW BLOCK.*1813</match>
    <group>radius_port_blocked</group>
    <description>Tentative accès port RADIUS depuis IP non autorisée</description>
  </rule>

  <!-- ============================================
       ANOMALIES PHP-ADMIN
       ============================================ -->
  
  <!-- PHP-Admin: Tentative injection SQL détectée -->
  <rule id="5080" level="7">
    <match>SQL injection|union select|drop table|delete from</match>
    <group>web_attack</group>
    <description>Tentative d'injection SQL détectée dans logs PHP-Admin</description>
  </rule>

  <!-- PHP-Admin: Erreur 500 (problème grave) -->
  <rule id="5081" level="6">
    <match>500 Internal Server Error</match>
    <group>web_error</group>
    <description>Erreur 500 sur interface PHP-Admin</description>
  </rule>

  <!-- ============================================
       ALERTES RÉSEAU CRITIQUES
       ============================================ -->
  
  <!-- Scan de port détecté -->
  <rule id="5090" level="6">
    <match>nmap|masscan|port scan</match>
    <group>network_scan</group>
    <description>Scan de port détecté sur le réseau</description>
  </rule>

  <!-- Activité SSH détectée -->
  <rule id="5091" level="4">
    <match>SSH|sshd|ssh_connection|ssh_login</match>
    <group>ssh_activity</group>
    <description>Activité SSH détectée</description>
  </rule>

  <!-- ============================================
       ALERTES D'INTÉGRITÉ FICHIERS
       ============================================ -->
  
  <!-- Fichier FreeRADIUS modifié -->
  <rule id="5100" level="7">
    <match>File integrity|FIM alert|/etc/freeradius</match>
    <group>integrity_check</group>
    <description>Intégrité fichier FreeRADIUS compromise</description>
  </rule>

  <!-- Répertoire web modifié -->
  <rule id="5101" level="6">
    <match>File integrity|FIM alert|/var/www/html</match>
    <group>integrity_check</group>
    <description>Intégrité répertoire web compromise</description>
  </rule>

  <!-- Fichier système modifié -->
  <rule id="5102" level="8">
    <match>File integrity|FIM alert|/etc/passwd|/etc/shadow|/etc/sudoers</match>
    <group>integrity_check</group>
    <description>Fichier système critique modifié - Sécurité compromise</description>
  </rule>

</group>

<!-- ============================================
     NOTES DE CONFIGURATION
     ============================================ -->
<!--
  Niveaux d'alerte Wazuh:
  
  0: Ignoré (warnings non critiques)
  1-3: Notifications (logs normaux)
  4-5: Avertissements (comportements inhabituels)
  6-7: Alertes (vénements sécurité)
  8-9: Alertes critiques (attaques/compromissions)
  10-15: Sévérité maximale (alerter immédiatement)
  
  Tags utilisés:
  - radius_auth_success: Authentification réussie
  - radius_auth_failure: Authentification échouée
  - radius_info: Informations non critiques (level 0 = ignoré)
  - radius_tls_error: Erreurs TLS/certificat
  - ssh_auth_failure: Échec authentification SSH
  - ssh_root_attack: Tentative connexion root
  - privilege_escalation: Escalade de privilèges
  - file_modified: Modification fichier critique
  - integrity_check: Vérification intégrité FIM
  - service_stopped: Service critique arrêté
  
  Format logs RADIUS attendu (module linelog):
  Feb  2 19:48:09 user=alice@gym.fr result=Access-Accept client=192.168.10.1 nas=192.168.10.1 mac=aa:bb:cc:dd:ee:ff auth_type=PEAP
  
  Vérification syntaxe:
  
  # Copier le fichier
  $ docker cp wazuh/local_rules.xml single-node-wazuh.manager-1:/var/ossec/etc/rules/
  $ docker exec single-node-wazuh.manager-1 chown root:wazuh /var/ossec/etc/rules/local_rules.xml
  $ docker exec single-node-wazuh.manager-1 chmod 640 /var/ossec/etc/rules/local_rules.xml
  
  # Test syntaxe
  $ docker exec single-node-wazuh.manager-1 /var/ossec/bin/wazuh-logtest
  
  # Redémarrer Wazuh
  $ docker exec single-node-wazuh.manager-1 /var/ossec/bin/wazuh-control restart
  
  # Vérifier
  $ docker exec single-node-wazuh.manager-1 tail -f /var/ossec/logs/ossec.log
  
  Changements v2.0 (2 février 2026):
  - CORRECTION patterns: "Result=Access-Accept" au lieu de "Received Access-Accept"
  - AJOUT règles 5012 et 5013 (level 0) pour ignorer warnings MySQL non critiques
  - SIMPLIFICATION règle 5021: seulement vraies erreurs MySQL
  - Adaptation au format réel du module linelog de FreeRADIUS
-->
